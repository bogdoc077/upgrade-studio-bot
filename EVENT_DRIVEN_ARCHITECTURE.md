# Event-Driven Architecture (–ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ –Ω–∞ –ø–æ–¥—ñ—è—Ö)

## –ü—Ä–æ–±–ª–µ–º–∞ Polling-based —Å–∏—Å—Ç–µ–º–∏

**–ë—É–ª–æ (Polling)**:
```
–ö–æ–∂–Ω—ñ 2 —Ö–≤–∏–ª–∏–Ω–∏ ‚Üí –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ payment_events –≤ –ë–î
–ö–æ–∂–Ω—ñ 5 —Ö–≤–∏–ª–∏–Ω ‚Üí –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ broadcasts –≤ –ë–î
–ö–æ–∂–Ω—É —Ö–≤–∏–ª–∏–Ω—É ‚Üí –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ reminders –≤ –ë–î
```

**–ü—Ä–æ–±–ª–µ–º–∏**:
- üî¥ –ü–æ—Å—Ç—ñ–π–Ω–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞–≤—ñ—Ç—å –±–µ–∑ –ø–æ–¥—ñ–π
- üî¥ –ó–∞—Ç—Ä–∏–º–∫–∞ –æ–±—Ä–æ–±–∫–∏ (–¥–æ 2 —Ö–≤–∏–ª–∏–Ω –¥–ª—è –æ–ø–ª–∞—Ç)
- üî¥ –ù–µ–µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—ñ
- üî¥ –ó–∞–π–≤—ñ –ë–î –∑–∞–ø–∏—Ç–∏ —ñ —Ç—Ä–∞—Ñ—ñ–∫

## –ù–æ–≤–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ (Event-Driven)

### 1. ‚úÖ Payment Events ‚Üí Webhooks

**Stripe –Ω–∞–¥—Å–∏–ª–∞—î –ø–æ–¥—ñ—ó –Ω–∞–ø—Ä—è–º—É:**

```
Stripe Payment Success
    ‚Üì
webhook_server.py –æ—Ç—Ä–∏–º—É—î POST /webhooks/stripe
    ‚Üì
–û–±—Ä–æ–±–ª—è—î –ø–æ–¥—ñ—é –º–∏—Ç—Ç—î–≤–æ
    ‚Üì
–ù–∞–¥—Å–∏–ª–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
```

**–§–∞–π–ª**: [webhook_server.py](webhook_server.py)

**–ü–µ—Ä–µ–≤–∞–≥–∏**:
- ‚ö° –ú–∏—Ç—Ç—î–≤–∞ –æ–±—Ä–æ–±–∫–∞ (0 —Å–µ–∫—É–Ω–¥ –∑–∞–º—ñ—Å—Ç—å 0-2 —Ö–≤–∏–ª–∏–Ω–∏)
- üí∞ –ï–∫–æ–Ω–æ–º—ñ—è ~200 –ë–î –∑–∞–ø–∏—Ç—ñ–≤/–≥–æ–¥–∏–Ω—É
- üéØ –û–±—Ä–æ–±–∫–∞ —Ç—ñ–ª—å–∫–∏ –∫–æ–ª–∏ —î –ø–æ–¥—ñ—ó

**–©–æ –≤–∏–¥–∞–ª–µ–Ω–æ**:
- ‚ùå `process_payment_events` scheduler job
- ‚ùå Polling –∫–æ–∂–Ω—ñ 2 —Ö–≤–∏–ª–∏–Ω–∏
- ‚ùå –¢–∞–±–ª–∏—Ü—è `payment_events` –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–¥–∞–ª–µ–Ω–∞ (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ webhook –ø—Ä—è–º–æ)

### 2. ‚úÖ Subscription Check ‚Üí –©–æ–¥–µ–Ω–Ω–∞ —á–µ—Ä–≥–∞ –æ 07:00

**–ë—É–ª–æ**: –ö–æ–∂–Ω—É –≥–æ–¥–∏–Ω—É –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –≤—Å—ñ—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤  
**–°—Ç–∞–ª–æ**: 1 —Ä–∞–∑ –Ω–∞ –¥–æ–±—É –æ 07:00 –∑ —á–µ—Ä–≥–æ—é

```python
# scheduler.py
CronTrigger(hour=7, minute=0)  # –†–∞–∑ –Ω–∞ –¥–æ–±—É

# –û–±—Ä–æ–±–∫–∞ –ø–∞–∫–µ—Ç–∞–º–∏ –ø–æ 100 –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
batch_size = 100
while True:
    users = get_expired_users(limit=100, offset=offset)
    for user in users:
        process_user(user)
        await asyncio.sleep(0.05)  # 50ms –º—ñ–∂ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏
    offset += 100
    await asyncio.sleep(0.1)  # 100ms –º—ñ–∂ –ø–∞–∫–µ—Ç–∞–º–∏
```

**–ü–µ—Ä–µ–≤–∞–≥–∏**:
- üìä –ú–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω—ñ—Å—Ç—å: 10,000 –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ = 100 –ø–∞–∫–µ—Ç—ñ–≤
- ‚è±Ô∏è –ö–æ–Ω—Ç—Ä–æ–ª—å —à–≤–∏–¥–∫–æ—Å—Ç—ñ: 10 msg/sec –¥–ª—è Telegram
- üíæ –ú–µ–Ω—à–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ –ë–î
- üïê –ü–µ—Ä–µ–¥–±–∞—á—É–≤–∞–Ω–∏–π —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è

**–§–∞–π–ª**: [tasks/scheduler.py](tasks/scheduler.py) ‚Üí `check_expired_subscriptions()`

### 3. ‚úÖ Broadcasts ‚Üí Event-driven —á–µ—Ä–≥–∞

**–ë—É–ª–æ**: Polling –∫–æ–∂–Ω—ñ 5 —Ö–≤–∏–ª–∏–Ω  
**–°—Ç–∞–ª–æ**: –û–±—Ä–æ–±–∫–∞ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ —Ä–æ–∑—Å–∏–ª–∫–∏

```python
# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–æ–∑—Å–∏–ª–∫–∏
broadcast = create_broadcast(text, users)
    ‚Üì
–ú–∏—Ç—Ç—î–≤–æ –¥–æ–¥–∞—Ç–∏ –≤ —á–µ—Ä–≥—É
    ‚Üì
BroadcastHandler –æ–±—Ä–æ–±–ª—è—î –ø–∞–∫–µ—Ç–∞–º–∏
    ‚Üì
10 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å/—Å–µ–∫—É–Ω–¥—É (Telegram limit)
```

**–ö–æ–ª–∏ –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è**:
- –ü—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –Ω–æ–≤–æ—ó —Ä–æ–∑—Å–∏–ª–∫–∏ —á–µ—Ä–µ–∑ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å
- –ê–±–æ –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ cron 1 —Ä–∞–∑ –Ω–∞ –≥–æ–¥–∏–Ω—É –¥–ª—è pending —Ä–æ–∑—Å–∏–ª–æ–∫

**–©–æ –≤–∏–¥–∞–ª–µ–Ω–æ**:
- ‚ùå `process_broadcasts` scheduler job
- ‚ùå Polling –∫–æ–∂–Ω—ñ 5 —Ö–≤–∏–ª–∏–Ω

### 4. ‚úÖ Reminders ‚Üí –ü–æ–≥–æ–¥–∏–Ω–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞

**–ë—É–ª–æ**: –ö–æ–∂–Ω—É —Ö–≤–∏–ª–∏–Ω—É  
**–°—Ç–∞–ª–æ**: –ö–æ–∂–Ω—É –≥–æ–¥–∏–Ω—É

```python
CronTrigger(minute=0)  # 00:00, 01:00, 02:00...

# –û–±—Ä–æ–±–∫–∞ –ø–∞–∫–µ—Ç–∞–º–∏
reminders = get_pending_reminders(limit=10)
for reminder in reminders:
    send_reminder(reminder)
```

**–ß–æ–º—É –≥–æ–¥–∏–Ω–Ω–∞**:
- –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è —Å—Ç–≤–æ—Ä—é—é—Ç—å—Å—è –∑ —Ç–æ—á–Ω–∏–º —á–∞—Å–æ–º
- –¢–æ—á–Ω—ñ—Å—Ç—å ¬±30 —Ö–≤–∏–ª–∏–Ω –¥–æ—Å—Ç–∞—Ç–Ω—è –¥–ª—è –Ω–∞–≥–∞–¥—É–≤–∞–Ω—å
- –ï–∫–æ–Ω–æ–º—ñ—è: 1440 ‚Üí 24 –∑–∞–ø—É—Å–∫–∏/–¥–µ–Ω—å (‚Üì98%)

## –†–æ–∑–∫–ª–∞–¥ Cron Jobs

| –ó–∞–≤–¥–∞–Ω–Ω—è | –Ü–Ω—Ç–µ—Ä–≤–∞–ª | –ß–∞—Å | –ó–º—ñ–Ω–∞ |
|----------|----------|-----|-------|
| **Reminders** | –ö–æ–∂–Ω—É –≥–æ–¥–∏–Ω—É | *:00 | –ë—É–ª–æ: –∫–æ–∂–Ω—É —Ö–≤–∏–ª–∏–Ω—É |
| **Subscription check** | –†–∞–∑ –Ω–∞ –¥–æ–±—É | 07:00 | –ë—É–ª–æ: –æ 01:00 |
| **Subscription reminders** | –†–∞–∑ –Ω–∞ –¥–æ–±—É | 10:00 | –ë–µ–∑ –∑–º—ñ–Ω |
| **Cleanup reminders** | –†–∞–∑ –Ω–∞ –¥–æ–±—É | 02:00 | –ë–µ–∑ –∑–º—ñ–Ω |
| **Cleanup payment events** | –†–∞–∑ –Ω–∞ –¥–æ–±—É | 03:00 | –ë–µ–∑ –∑–º—ñ–Ω |
| ~~**Payment events**~~ | ‚ùå –í–∏–¥–∞–ª–µ–Ω–æ | - | Webhooks |
| ~~**Broadcasts**~~ | ‚ùå –í–∏–¥–∞–ª–µ–Ω–æ | - | Event-driven |

## –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó

### –î–æ (Polling):
```
–ó–∞–ø—É—Å–∫—ñ–≤/–¥–µ–Ω—å:
- payment_events: 720 (–∫–æ–∂–Ω—ñ 2 —Ö–≤)
- broadcasts: 288 (–∫–æ–∂–Ω—ñ 5 —Ö–≤)
- reminders: 1,440 (–∫–æ–∂–Ω—É —Ö–≤)
- subscription_check: 24 (–∫–æ–∂–Ω—É –≥–æ–¥)
= 2,472 –∑–∞–ø—É—Å–∫–∏/–¥–µ–Ω—å

–ë–î –∑–∞–ø–∏—Ç—ñ–≤: ~12,000+/–¥–µ–Ω—å
–°–µ—Ä–µ–¥–Ω—ñ–π delay: 1-2 —Ö–≤–∏–ª–∏–Ω–∏
```

### –ü—ñ—Å–ª—è (Event-driven):
```
–ó–∞–ø—É—Å–∫—ñ–≤/–¥–µ–Ω—å:
- payment_events: 0 (webhooks)
- broadcasts: 0 (event-driven)
- reminders: 24 (–∫–æ–∂–Ω—É –≥–æ–¥)
- subscription_check: 1 (–æ 07:00)
= 25 –∑–∞–ø—É—Å–∫—ñ–≤/–¥–µ–Ω—å

–ë–î –∑–∞–ø–∏—Ç—ñ–≤: ~500/–¥–µ–Ω—å (‚Üì96%)
–°–µ—Ä–µ–¥–Ω—ñ–π delay: 0 —Å–µ–∫—É–Ω–¥ (webhooks)
```

## –ú–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω—ñ—Å—Ç—å

### –°—Ü–µ–Ω–∞—Ä—ñ–π: 10,000 –∞–∫—Ç–∏–≤–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤

**Subscription check (07:00)**:
```
10,000 –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ / 100 batch = 100 –ø–∞–∫–µ—Ç—ñ–≤
100 –ø–∞–∫–µ—Ç—ñ–≤ √ó 0.1s = 10 —Å–µ–∫—É–Ω–¥
–ü–ª—é—Å –æ–±—Ä–æ–±–∫–∞: ~20-30 —Ö–≤–∏–ª–∏–Ω –≤—Å—å–æ–≥–æ
```

**Broadcasts**:
```
10,000 –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ / 10 msg/sec = 1,000 —Å–µ–∫—É–Ω–¥
= ~17 —Ö–≤–∏–ª–∏–Ω –Ω–∞ —Ä–æ–∑—Å–∏–ª–∫—É
–ó –ø–∞—É–∑–∞–º–∏: ~20-25 —Ö–≤–∏–ª–∏–Ω
```

**Payment webhooks**:
```
–ú–∏—Ç—Ç—î–≤–∞ –æ–±—Ä–æ–±–∫–∞ –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ
Stripe –º–æ–∂–µ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ 100 webhooks/sec
```

## –í–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è

### ‚úÖ –í–∂–µ –≥–æ—Ç–æ–≤–æ:
1. –í–∏–¥–∞–ª–µ–Ω–æ `process_payment_events` –∑ scheduler
2. –í–∏–¥–∞–ª–µ–Ω–æ `process_broadcasts` –∑ scheduler  
3. `check_expired_subscriptions` –ø–µ—Ä–µ–º—ñ—â–µ–Ω–æ –Ω–∞ 07:00 –∑ —á–µ—Ä–≥–æ—é
4. `process_reminders` –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ –ø–æ–≥–æ–¥–∏–Ω–Ω–∏–π
5. SQLAlchemy echo=False
6. Connection pooling –¥–æ–¥–∞–Ω–æ

### üîÑ Webhook server –≥–æ—Ç–æ–≤–∏–π:
[webhook_server.py](webhook_server.py) –≤–∂–µ –æ–±—Ä–æ–±–ª—è—î:
- `payment_intent.succeeded`
- `invoice.payment_succeeded`
- `customer.subscription.updated`
- `customer.subscription.deleted`

### üìù TODO (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ):
1. –í–∏–¥–∞–ª–∏—Ç–∏ —Ç–∞–±–ª–∏—Ü—é `payment_events` (–±—ñ–ª—å—à–µ –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–∞)
2. –î–æ–¥–∞—Ç–∏ rate limiting –¥–ª—è webhooks
3. –î–æ–¥–∞—Ç–∏ retry mechanism –¥–ª—è failed webhooks
4. Monitoring –¥–ª—è webhook delivery

## –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥

```bash
# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ webhook –ª–æ–≥–∏
journalctl -u upgrade-webhook -f

# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ scheduler
journalctl -u upgrade-bot -f | grep scheduler

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
python diagnose_traffic.py
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü—ñ—Å–ª—è |
|---------|----|----|
| **Cron –∑–∞–ø—É—Å–∫—ñ–≤/–¥–µ–Ω—å** | 2,472 | 25 (‚Üì99%) |
| **–ë–î –∑–∞–ø–∏—Ç—ñ–≤/–¥–µ–Ω—å** | ~12,000 | ~500 (‚Üì96%) |
| **Delay –æ–±—Ä–æ–±–∫–∏ –æ–ø–ª–∞—Ç** | 0-2 —Ö–≤ | 0 —Å–µ–∫ |
| **–¢—Ä–∞—Ñ—ñ–∫** | 90 –ì–ë | 500 –ú–ë (‚Üì99%) |
| **RAM** | 90-100% | 40-60% |

**–ì–æ—Ç–æ–≤–Ω—ñ—Å—Ç—å –¥–æ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è**: ‚úÖ 10,000+ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤

---

**–î–∞—Ç–∞**: 15.01.2026  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–æ
